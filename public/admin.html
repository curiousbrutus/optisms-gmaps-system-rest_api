<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Anket Yönetimi</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{ font-family: Inter,system-ui,-apple-system,Arial,sans-serif; margin:0; background:#0b1f3a; color:#e6edf6; }
    .wrap{ max-width:1100px; margin:0 auto; padding:24px; }
    .card{ background:#0f274b; border:1px solid #173a6b; border-radius:12px; padding:16px; }
    h1{ margin:0 0 12px; font-size:22px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:end; }
    label{ font-size:12px; color:#a8b3c7; display:block; margin-bottom:4px; }
    input,select{ background:#0e2b58; border:1px solid #173a6b; color:#e6edf6; border-radius:8px; padding:8px 10px; }
    button{ background:#f97316; border:1px solid #ea580c; color:#0b0f14; border-radius:8px; padding:8px 12px; cursor:pointer; }
    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th,td{ padding:8px; border-bottom:1px solid #173a6b; font-size:14px; }
    th{ text-align:left; color:#a8b3c7; font-weight:600; }
    .muted{ color:#a8b3c7; font-size:12px; }
  .actions{ display:flex; gap:8px; align-items:center; }
  .metrics{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin-top:12px; }
  .metric{ background:#0e2b58; border:1px solid #173a6b; border-radius:10px; padding:10px; }
  .metric .label{ font-size:12px; color:#a8b3c7; }
  .metric .val{ font-size:18px; font-weight:600; }
  </style>
  <script>
    function statAvg(arr){ if(!arr.length) return 0; return Math.round((arr.reduce((a,b)=>a+b,0)/arr.length)*100)/100; }
    function statusTr(s){
      switch(String(s||'').toLowerCase()){
        case 'pending': return 'Beklemede';
        case 'promoted': return 'Yönlendirildi';
        case 'completed': return 'Tamamlandı';
        default: return s||'';
      }
    }
  function isWithinDays(dateStr, days){ const d=new Date(dateStr.replace(' ','T')); const now=new Date(); const diff=(now-d)/(1000*60*60*24); return diff <= days; }
  async function load(){
      const q = document.getElementById('q').value.trim();
      const from = document.getElementById('from').value;
      const to = document.getElementById('to').value;
      const status = document.getElementById('status').value;
      const params = new URLSearchParams();
      if(q) params.set('q', q);
      if(from) params.set('from', from);
      if(to) params.set('to', to);
      if(status) params.set('status', status);
  const res = await fetch('/admin/api/surveys?'+params.toString());
      const data = await res.json();
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      const genelList=[]; const highList=[]; let last7=0;
      for(const r of data.items){
        const g = (r.Genel==null)?null:Number(r.Genel);
        if (g!=null && !Number.isNaN(g)) { genelList.push(g); if (g>=Number((window.SCORE_THRESHOLD||8))) highList.push(g); }
        if (r.KayitTarihi && isWithinDays(r.KayitTarihi,7)) last7++;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><a href="/s/${r.SurveyId}" target="_blank">${r.SurveyId}</a></td>
          <td>${r.Tarih||''}</td>
          <td>${r.AdSoyad||''}</td>
          <td>${r.Telefon||''}</td>
          <td>${r.Bolum||''}</td>
          <td>${r.Doktor||''}</td>
          <td>${r.Genel??''}</td>
          <td>${r.Bekleme??''}</td>
          <td>${r.DoktorSkor??''}</td>
          <td>${r.Ekip??''}</td>
          <td>${r.Banko??''}</td>
          <td>${r.Servis??''}</td>
          <td>${r.Temizlik??''}</td>
          <td>${r.Tavsiye??''}</td>
          <td>${(r.Yorum||'').toString().slice(0,80)}</td>
          <td>${statusTr(r.Durum)}</td>
        `;
        tbody.appendChild(tr);
      }
  document.getElementById('total').textContent = data.total;
  const avg = statAvg(genelList);
  const highRate = (genelList.length? Math.round((highList.length/genelList.length)*100):0);
  document.getElementById('m-avg').textContent = avg.toString();
  document.getElementById('m-high').textContent = highRate + '%';
  document.getElementById('m-last7').textContent = String(last7);
    }
    function csv(){ window.location.href = '/api/export/csv'; }
    window.addEventListener('DOMContentLoaded', load);
  </script>
</head>
<body>
  <div class="wrap">
    <h1>Anketler</h1>
    <div class="card">
      <div class="metrics">
        <div class="metric"><div class="label">Toplam</div><div class="val" id="total">0</div></div>
        <div class="metric"><div class="label">Ortalama Genel</div><div class="val" id="m-avg">0</div></div>
        <div class="metric"><div class="label">8+ Oranı</div><div class="val" id="m-high">0%</div></div>
        <div class="metric"><div class="label">Son 7 Gün</div><div class="val" id="m-last7">0</div></div>
      </div>
      <div class="row">
        <div>
          <label>Ara (ad/telefon/bölüm/doktor)</label>
          <input id="q" placeholder="ör: Ali veya +90555…" />
        </div>
        <div>
          <label>Başlangıç (yyyy-mm-dd)</label>
          <input id="from" type="date" />
        </div>
        <div>
          <label>Bitiş (yyyy-mm-dd)</label>
          <input id="to" type="date" />
        </div>
        <div>
          <label>Durum</label>
          <select id="status">
            <option value="">Hepsi</option>
            <option>pending</option>
            <option>completed</option>
            <option>promoted</option>
          </select>
        </div>
        <div class="actions">
          <button onclick="load()">Listele</button>
          <button onclick="csv()">CSV İndir</button>
          <span class="muted">Toplam: <span id="total">0</span></span>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Tarih</th><th>Ad Soyad</th><th>Telefon</th>
            <th>Bölüm</th><th>Doktor</th><th>Genel</th>
            <th>Bekleme</th><th>Doktor</th><th>Ekip</th><th>Banko</th><th>Servis</th><th>Temizlik</th>
            <th>Tavsiye</th><th>Yorum</th><th>Durum</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</body>
</html>
